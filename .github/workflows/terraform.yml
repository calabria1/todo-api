name: Deploy Lambda (tarefas)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: sa-east-1
  ARTIFACTS_BUCKET: gestao-tarefas-dev-artifacts-calabria1-sa-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo da API
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build Lambda zip (tarefas)
        run: |
          set -euo pipefail

          ARTIFACT_VERSION="${GITHUB_SHA:0:7}"
          echo "ARTIFACT_VERSION=$ARTIFACT_VERSION" >> $GITHUB_ENV

          ROOT="$(pwd)"
          SRC_DIR="$ROOT/services/tasks/src"
          REQ_FILE="$ROOT/services/tasks/requirements.txt"
          OUT_DIR="$ROOT/build"
          PKG_DIR="$ROOT/.package/tarefas"

          rm -rf "$OUT_DIR" "$PKG_DIR"
          mkdir -p "$OUT_DIR" "$PKG_DIR"

          python -m pip install --upgrade pip
          if [ -f "$REQ_FILE" ]; then
            python -m pip install -r "$REQ_FILE" -t "$PKG_DIR"
          fi

          cp -R "$SRC_DIR/"* "$PKG_DIR/"
          (cd "$PKG_DIR" && zip -qr "$OUT_DIR/tasks.zip" .)

          echo "Built: $OUT_DIR/tasks.zip"
          ls -lh "$OUT_DIR/tasks.zip"

      - name: Upload Lambda zip to S3
        run: |
          set -euo pipefail
          aws s3 cp build/tasks.zip "s3://${{ env.ARTIFACTS_BUCKET }}/lambdas/tasks/${ARTIFACT_VERSION}.zip"
          aws s3 cp build/tasks.zip "s3://${{ env.ARTIFACTS_BUCKET }}/lambdas/tasks/latest.zip"
